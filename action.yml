name: 'phpcs-ci-action'
description: 'PHP code sniffing action to use on PR and pushes'
inputs:
    token:  # id of input
        description: 'Github token'
        required: true
        default: ''
runs:
    using: "composite"
    steps:
        - uses: actions/checkout@v3
          with:
              fetch-depth: 0
        - run: GIT_MODIFIED_FILES_LIST=$(git diff --name-only --diff-filter=AM `git merge-base origin/master HEAD` | grep .php$ || true | xargs)
          env:
              GITHUB_TOKEN: ${{ inputs.token }}
          shell: bash
        - run: |
              GIT_CHANGED_FILES_AND_LINES=$(git diff --unified=0 --diff-filter=AM `git merge-base origin/master HEAD` | grep -Po '^\+\+\+ ./\K.*|^@@ -[0-9]+(,[0-9]+)? \+\K[0-9]+(,[0-9]+)?(?= @@)')
              echo "$GIT_CHANGED_FILES_AND_LINES" > git_changed_files_and_lines.txt
          env:
              GITHUB_TOKEN: ${{ inputs.token }}
          shell: bash
        - uses: shivammathur/setup-php@v2
          with:
              php-version: '7.4'
              coverage: none
        - run: composer validate
          shell: bash
        - run: |
              composer config --global github-oauth.github.com ${{inputs.token}}
              composer install --no-interaction --no-ansi --prefer-dist --no-suggest --ignore-platform-reqs
          shell: bash
        - run: |
              vendor/squizlabs/php_codesniffer/bin/phpcs --config-set ignore_errors_on_exit 1
              vendor/squizlabs/php_codesniffer/bin/phpcs --config-set ignore_warnings_on_exit 1
              SNIFFER_OUTPUT=$(vendor/squizlabs/php_codesniffer/bin/phpcs --standard=PSR12 --report=csv "$GIT_MODIFIED_FILES_LIST")
              echo "$SNIFFER_OUTPUT"
              echo "$SNIFFER_OUTPUT" > report.csv
              cat git_changed_files_and_lines.txt
              SNIFFER_FILTERED=$(php tests/code_sniffer/start.php report.csv git_changed_files_and_lines.txt /__w/pdffiller/pdffiller/)
              echo "$SNIFFER_FILTERED"
              echo "$SNIFFER_FILTERED" > sniffer_output.txt
          shell: bash
